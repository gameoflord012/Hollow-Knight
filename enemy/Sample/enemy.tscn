[gd_scene load_steps=10 format=3 uid="uid://by18bfq07s8m7"]

[ext_resource type="Script" path="res://enemy/BehaviorTree/BehaviorTreeRoot.gd" id="1_1vbyk"]
[ext_resource type="Script" path="res://enemy/Sample/enemy.gd" id="1_05tvl"]
[ext_resource type="Script" path="res://enemy/BehaviorTree/Composites/Sequence.gd" id="2_od4yp"]
[ext_resource type="Script" path="res://enemy/BehaviorTree/Leaves/Action.gd" id="3_if5iy"]
[ext_resource type="Script" path="res://enemy/BehaviorTree/Composites/Selector.gd" id="4_hxrqu"]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_7cvo5"]
radius = 15.0
height = 46.0

[sub_resource type="GDScript" id="GDScript_dhn0e"]
script/source = "extends ConditionLeaf

@export var detect_range : float = 00

func tick(actor, blackboard):
	var target = get_tree().get_first_node_in_group(\"Player\")
	if target == null:
		return FAILURE
	
	if actor.position.distance_to(target.position) < detect_range:
		return SUCCESS
		
	return FAILURE
"

[sub_resource type="GDScript" id="GDScript_puocv"]
script/source = "extends ActionLeaf


func tick(actor, blackboard):
	return FAILURE
"

[sub_resource type="GDScript" id="GDScript_y6n4o"]
script/source = "extends ActionLeaf

@export var wander_speed : float = 80

var wander_direction : Vector2 = Vector2(0, 0)
var wander_duration : float = -1
var wander_counter : float = 0

func tick(actor, blackboard):
	if wander_duration == -1:
		wander_duration = randf_range(2, 4)
		wander_direction = Vector2(randi_range(-1, 1), 0)
	
	if is_blocked(actor, wander_direction):
		wander_duration = -1
		wander_counter = 0
		return FAILURE
		
	actor.move_horizontal_direction(wander_direction.x, blackboard.b_get(\"delta\"))
	wander_counter += blackboard.b_get(\"delta\")
	
	if wander_counter >= wander_duration:
		wander_duration = -1
		wander_counter = 0
		return SUCCESS
	
	return RUNNING

func is_blocked(actor, direction) -> bool:
	var obstacles = Physics2D.linecast(actor, actor.position, actor.position + direction * 30, 1, [])
	
	if obstacles.size() == 0:
		return false
		
	return true

func _draw():
	draw_line(Vector2(-30, 0), Vector2(30, 0), Color.YELLOW)
	
"

[node name="Enemy" type="CharacterBody2D"]
script = ExtResource("1_05tvl")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource("CapsuleShape2D_7cvo5")

[node name="BehaviorTreeRoot" type="Node2D" parent="."]
script = ExtResource("1_1vbyk")

[node name="SelectorComposite" type="Node2D" parent="BehaviorTreeRoot"]
script = ExtResource("4_hxrqu")

[node name="Attack" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite"]
script = ExtResource("2_od4yp")

[node name="isTargetInRange" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite/Attack"]
script = SubResource("GDScript_dhn0e")

[node name="followPlayer" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite/Attack"]
script = SubResource("GDScript_puocv")

[node name="attackPlayer" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite/Attack"]
script = ExtResource("3_if5iy")

[node name="Wander" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite"]
script = ExtResource("4_hxrqu")

[node name="moveForward" type="Node2D" parent="BehaviorTreeRoot/SelectorComposite/Wander"]
script = SubResource("GDScript_y6n4o")
